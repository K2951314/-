name: Sync Stock Bundle

on:
  schedule:
    - cron: "0 16 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: sync-stock-bundle
  cancel-in-progress: false

jobs:
  sync-stock:
    runs-on: ubuntu-latest
    env:
      STOCK_BRANCH: stock-data
      PRICE_BRANCH: price-data
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Validate required secret
        run: |
          if [ -z "${{ secrets.STOCK_SOURCE_URL }}" ]; then
            echo "STOCK_SOURCE_URL is not set"
            exit 1
          fi

      - name: Seed previous stock artifact (for conditional request)
        run: |
          TARGET=$(node -e "const c=require('./config/system.json'); process.stdout.write(c.app.stock_bundle_path)")
          mkdir -p tmp
          git fetch origin "$STOCK_BRANCH" || true
          if git show "origin/$STOCK_BRANCH:$TARGET" >/dev/null 2>&1; then
            git show "origin/$STOCK_BRANCH:$TARGET" > tmp/stock.bundle.js
            echo "Seeded previous stock artifact from $STOCK_BRANCH"
          else
            echo "No previous stock artifact found on $STOCK_BRANCH"
          fi

      - name: Build stock bundle artifact
        env:
          STOCK_SOURCE_URL: ${{ secrets.STOCK_SOURCE_URL }}
          STOCK_SOURCE_TOKEN: ${{ secrets.STOCK_SOURCE_TOKEN }}
        run: |
          SCRIPT_PATH=$(node -e "const c=require('./config/system.json'); process.stdout.write(c.sync.script_path)")
          mkdir -p tmp
          node "$SCRIPT_PATH" --config config/system.json --stock-config config/stock-source.json --output tmp/stock.bundle.js

      - name: Publish stock bundle to stock-data branch
        run: |
          TARGET=$(node -e "const c=require('./config/system.json'); process.stdout.write(c.app.stock_bundle_path)")
          ARTIFACT="tmp/stock.bundle.js"
          if [ ! -f "$ARTIFACT" ]; then
            echo "Stock artifact not found: $ARTIFACT"
            exit 1
          fi

          git fetch origin "$STOCK_BRANCH" || true
          WORKTREE_DIR=$(mktemp -d)
          BRANCH_EXISTS=0
          if git show-ref --verify --quiet "refs/remotes/origin/$STOCK_BRANCH"; then
            BRANCH_EXISTS=1
            git worktree add -B "$STOCK_BRANCH" "$WORKTREE_DIR" "origin/$STOCK_BRANCH"
          else
            git worktree add -B "$STOCK_BRANCH" "$WORKTREE_DIR"
          fi

          mkdir -p "$WORKTREE_DIR/$(dirname "$TARGET")"
          if [ -f "$WORKTREE_DIR/$TARGET" ] && cmp -s "$ARTIFACT" "$WORKTREE_DIR/$TARGET"; then
            echo "No stock bundle changes"
            if [ "$BRANCH_EXISTS" = "0" ]; then
              cd "$WORKTREE_DIR"
              git push origin HEAD:"$STOCK_BRANCH"
              cd - >/dev/null
            fi
            git worktree remove "$WORKTREE_DIR" --force
            exit 0
          fi

          cp "$ARTIFACT" "$WORKTREE_DIR/$TARGET"
          cd "$WORKTREE_DIR"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$TARGET"
          if git diff --cached --quiet; then
            echo "No staged changes"
            cd - >/dev/null
            git worktree remove "$WORKTREE_DIR" --force
            exit 0
          fi
          git commit -m "chore: auto-sync stock bundle"
          git push origin HEAD:"$STOCK_BRANCH"
          cd - >/dev/null
          git worktree remove "$WORKTREE_DIR" --force

      - name: Publish price bundle to price-data branch
        run: |
          TARGET=$(node -e "const c=require('./config/system.json'); process.stdout.write(c.app.price_bundle_path)")
          ARTIFACT="$TARGET"
          if [ ! -f "$ARTIFACT" ]; then
            echo "Price artifact not found: $ARTIFACT"
            exit 1
          fi

          git fetch origin "$PRICE_BRANCH" || true
          WORKTREE_DIR=$(mktemp -d)
          BRANCH_EXISTS=0
          if git show-ref --verify --quiet "refs/remotes/origin/$PRICE_BRANCH"; then
            BRANCH_EXISTS=1
            git worktree add -B "$PRICE_BRANCH" "$WORKTREE_DIR" "origin/$PRICE_BRANCH"
          else
            git worktree add -B "$PRICE_BRANCH" "$WORKTREE_DIR"
          fi

          mkdir -p "$WORKTREE_DIR/$(dirname "$TARGET")"
          if [ -f "$WORKTREE_DIR/$TARGET" ] && cmp -s "$ARTIFACT" "$WORKTREE_DIR/$TARGET"; then
            echo "No price bundle changes"
            if [ "$BRANCH_EXISTS" = "0" ]; then
              cd "$WORKTREE_DIR"
              git push origin HEAD:"$PRICE_BRANCH"
              cd - >/dev/null
            fi
            git worktree remove "$WORKTREE_DIR" --force
            exit 0
          fi

          cp "$ARTIFACT" "$WORKTREE_DIR/$TARGET"
          cd "$WORKTREE_DIR"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$TARGET"
          if git diff --cached --quiet; then
            echo "No staged changes"
            cd - >/dev/null
            git worktree remove "$WORKTREE_DIR" --force
            exit 0
          fi
          git commit -m "chore: auto-sync price bundle"
          git push origin HEAD:"$PRICE_BRANCH"
          cd - >/dev/null
          git worktree remove "$WORKTREE_DIR" --force
